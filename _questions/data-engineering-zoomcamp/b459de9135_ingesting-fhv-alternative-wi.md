---
id: b459de9135
question: Ingesting FHV : alternative with kestra
section: Module 4: analytics engineering with dbt
course: data-engineering-zoomcamp
sort_order: 3120
---

Add this task based on the previous ones :

- id: if_fhv_taxi

type: io.kestra.plugin.core.flow.If

condition: "{{inputs.taxi == 'fhv'}}"

then:

- id: bq_fhv_tripdata

type: io.kestra.plugin.gcp.bigquery.Query

sql: |

CREATE TABLE IF NOT EXISTS `{{kv('GCP_PROJECT_ID')}}.{{kv('GCP_DATASET')}}.fhv_tripdata`

(

unique_row_id BYTES OPTIONS (description = 'A unique identifier for the trip, generated by hashing key trip attributes.'),

filename STRING OPTIONS (description = 'The source filename from which the trip data was loaded.'),

dispatching_base_num STRING,

pickup_datetime TIMESTAMP,

dropoff_datetime TIMESTAMP,

PUlocationID NUMERIC,

DOlocationID NUMERIC,

SR_Flag STRING,

Affiliated_base_number STRING

)

PARTITION BY DATE(pickup_datetime);

- id: bq_fhv_table_ext

type: io.kestra.plugin.gcp.bigquery.Query

sql: |

CREATE OR REPLACE EXTERNAL TABLE `{{kv('GCP_PROJECT_ID')}}.{{render(vars.table)}}_ext`

(

dispatching_base_num STRING,

pickup_datetime TIMESTAMP,

dropoff_datetime TIMESTAMP,

PUlocationID NUMERIC,

DOlocationID NUMERIC,

SR_Flag STRING,

Affiliated_base_number STRING

)

OPTIONS (

format = 'CSV',

uris = ['{{render(vars.gcs_file)}}'],

skip_leading_rows = 1,

ignore_unknown_values = TRUE

);

- id: bq_fhv_table_tmp

type: io.kestra.plugin.gcp.bigquery.Query

sql: |

CREATE OR REPLACE TABLE `{{kv('GCP_PROJECT_ID')}}.{{render(vars.table)}}`

AS

SELECT

MD5(CONCAT(

COALESCE(CAST(pickup_datetime AS STRING), ""),

COALESCE(CAST(dropoff_datetime AS STRING), ""),

COALESCE(CAST(PUlocationID AS STRING), ""),

COALESCE(CAST(DOLocationID AS STRING), "")

)) AS unique_row_id,

"{{render(vars.file)}}" AS filename,

*

FROM `{{kv('GCP_PROJECT_ID')}}.{{render(vars.table)}}_ext`;

- id: bq_fhv_merge

type: io.kestra.plugin.gcp.bigquery.Query

sql: |

MERGE INTO `{{kv('GCP_PROJECT_ID')}}.{{kv('GCP_DATASET')}}.fhv_tripdata` T

USING `{{kv('GCP_PROJECT_ID')}}.{{render(vars.table)}}` S

ON T.unique_row_id = S.unique_row_id

WHEN NOT MATCHED THEN

INSERT (unique_row_id, filename, dispatching_base_num, pickup_datetime, dropoff_datetime, PUlocationID, DOlocationID, SR_Flag, Affiliated_base_number)

VALUES (S.unique_row_id, S.filename, S.dispatching_base_num, S.pickup_datetime, S.dropoff_datetime, S.PUlocationID, S.DOlocationID, S.SR_Flag, S.Affiliated_base_number);

Add a trigger too :

- id: fhv_schedule

type: io.kestra.plugin.core.trigger.Schedule

cron: "0 11 1 * *"

inputs:

taxi: fhv

And modify inputs :

inputs:

- id: taxi

type: SELECT

displayName: Select taxi type

values: [yellow, green, fhv]

defaults: green

